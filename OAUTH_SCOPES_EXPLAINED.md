# OAuth 2.0 Scopes - Understanding .default vs Custom Scopes

## Overview

In OAuth 2.0 and Microsoft Entra ID (Azure AD), scopes define what permissions an access token grants. This document explains the different scope formats and when to use each.

## Scope Formats in This Project

### What We Use: `api://1d922779-2742-4cf2-8c82-425cf2c60aa8/access_as_user`

This is a **custom delegated scope** defined in our Entra ID app registration.

**Format**: `api://<ClientId>/<ScopeName>`

**Why We Use This**:
1. ✅ **User Consent Flow**: Users see exactly what permission they're granting ("Access API as you")
2. ✅ **Delegated Permission**: API acts on behalf of the signed-in user
3. ✅ **User Token**: Token contains user's identity claims (name, email, oid)
4. ✅ **Interactive Login**: User must sign in and consent
5. ✅ **SPA Best Practice**: Recommended for Single Page Applications
6. ✅ **Fine-Grained Permissions**: Can define multiple scopes for different API operations

**MISE Requirement**: Works with MISE when token includes `idtyp: "user"` claim

## Alternative Scope Formats (Not Used Here)

### Option 1: `api://1d922779-2742-4cf2-8c82-425cf2c60aa8/.default`

**Format**: `api://<ClientId>/.default`

**When to Use**:
- ❌ **NOT for SPAs** - Used for daemon/service applications
- ✅ **Service-to-Service** calls (no user context)
- ✅ **Client Credentials Flow** (app-only authentication)
- ✅ **Backend services** calling other backend services

**Behavior**:
- Requests ALL permissions pre-consented for the app
- Admin must pre-consent (no user consent UI)
- Returns app-only token (not user token)
- Token has `idtyp: "app"` claim
- No user identity in token

**Why We Don't Use This**:
- Our Angular SPA needs **user context** (who is logged in)
- MISE requires user tokens for delegated scenarios
- `.default` scope doesn't work with authorization code flow with PKCE from SPA
- We need user claims like name, email, oid in the token

### Option 2: `1d922779-2742-4cf2-8c82-425cf2c60aa8/.default`

**Format**: `<ClientId>/.default` (without `api://` prefix)

**When to Use**:
- ✅ **Microsoft Graph API** scenarios with app-only access
- ✅ **Server-side applications** using client credentials
- ✅ **Legacy compatibility** scenarios

**Behavior**:
- Same as Option 1 but older format
- Used when `Application ID URI` is not configured
- Falls back to using ClientId directly
- Still app-only token (no user context)

**Why We Don't Use This**:
- Same reasons as Option 1
- We explicitly configured `api://` URI for better clarity
- Modern best practice is to use `api://` prefix

## Detailed Comparison

| Feature | `access_as_user` | `.default` | `ClientId/.default` |
|---------|------------------|------------|---------------------|
| **User Context** | ✅ Yes | ❌ No | ❌ No |
| **Interactive Login** | ✅ Required | ❌ Not needed | ❌ Not needed |
| **User Claims** | ✅ name, email, oid | ❌ None | ❌ None |
| **Token Type** | User (delegated) | App-only | App-only |
| **idtyp Claim** | `user` | `app` | `app` |
| **Consent UI** | ✅ Shown to user | ❌ Admin pre-consent | ❌ Admin pre-consent |
| **Use Case** | SPA, Web Apps | Daemons, Services | Legacy Services |
| **PKCE Flow** | ✅ Supported | ❌ Not applicable | ❌ Not applicable |
| **Auth Flow** | Authorization Code | Client Credentials | Client Credentials |
| **Client Secret** | ❌ Not needed | ✅ Required | ✅ Required |
| **Our Scenario** | ✅ **Perfect fit** | ❌ Wrong type | ❌ Wrong type |

## When to Use Each Scope Type

### Use Custom Scope (`access_as_user`)

✅ **Your scenario if**:
- Building a SPA (Angular, React, Vue)
- Building a web application with user sign-in
- Need to know WHO is using the API
- API performs actions on behalf of the user
- Users should see what permissions they grant
- Using PKCE / Authorization Code flow
- No client secrets (public client)

**Example Applications**:
- Angular SPA calling ASP.NET Core API ← **Our Project**
- React app calling Node.js API
- Web app with user profiles
- Any user-facing application

### Use `.default` Scope

✅ **Your scenario if**:
- Building a daemon/background service
- No user interaction needed
- Service-to-service authentication
- App needs to run without user sign-in
- Using Client Credentials flow
- Have client secret or certificate
- Admin can pre-approve all permissions

**Example Applications**:
- Nightly batch jobs
- Background data sync services
- Monitoring/health check services
- Automated reporting systems

## Our Configuration in Detail

### Angular MSAL Configuration
```typescript
authRequest: {
  scopes: [
    'openid',              // OIDC: Basic identity
    'profile',             // OIDC: User profile info
    'api://1d922779-2742-4cf2-8c82-425cf2c60aa8/access_as_user'
  ]
}
```

## Tokens Generated by MSAL

**Important**: MSAL generates **BOTH** an ID token AND an Access token with this configuration.

### 1. ID Token (`id_token`)
- **Generated by**: The `openid` and `profile` scopes
- **Purpose**: Contains user identity claims for authentication
- **Claims included**: 
  - `name` - User's display name
  - `preferred_username` - User's email/UPN
  - `oid` - Object ID (user identifier)
  - `sub` - Subject identifier
  - Standard OIDC claims
- **Used for**: Displaying user information in the UI (like `userName` in the app)
- **Storage**: MSAL browser cache
- **NOT sent to API**: Never included in Authorization headers

### 2. Access Token (`access_token`)
- **Generated by**: The `api://1d922779-2742-4cf2-8c82-425cf2c60aa8/access_as_user` scope
- **Purpose**: Authorizes API calls to the ASP.NET Core backend
- **Claims included**:
  - `aud`: `1d922779-2742-4cf2-8c82-425cf2c60aa8` (API's ClientId)
  - `scp`: `access_as_user` (granted scope)
  - `idtyp`: `user` (identifies this as a user token)
  - User identity claims (name, preferred_username, oid)
  - `ver`: `2.0` (token version)
- **Used for**: Authorization header in HTTP requests (`Authorization: Bearer <access_token>`)
- **Validated by**: MISE authentication in ASP.NET Core services
- **Attached by**: MsalInterceptor automatically for protected resource URLs

### Token Flow Diagram

```
User Login Request
       ↓
    Entra ID
       ↓
  ┌────────────────┐
  │  Returns BOTH: │
  ├────────────────┤
  │ 1. ID Token    │ → Stored in MSAL cache → Used to display user info in Angular
  │ 2. Access Token│ → Stored in MSAL cache → Sent to API in Authorization header
  └────────────────┘
       ↓
   MSAL Cache (Browser LocalStorage)
       ↓
API Call (e.g., /weatherforecast)
       ↓
MsalInterceptor adds: Authorization: Bearer <access_token>
       ↓
ASP.NET Core API (MISE validates access token)
       ↓
User.Claims populated from access token (NOT id_token)
```

### What Each Scope Provides

1. **`openid`** (OpenID Connect scope)
   - Enables OIDC protocol
   - Returns `id_token` with basic claims
   - Required for user authentication

2. **`profile`** (OpenID Connect scope)
   - Adds profile claims to `id_token`
   - Includes: name, preferred_username, etc.
   - Standard OIDC scope

3. **`api://1d922779-2742-4cf2-8c82-425cf2c60aa8/access_as_user`** (Custom API scope)
   - Grants access to our API
   - Included in `access_token` (not `id_token`)
   - Validated by our API's MISE authentication
   - Proves user consented to API access

### Key Point About Token Usage

**The claims you see in your ASP.NET Core API** (`User.Identity.Name`, `User.Claims`) **come from the Access Token**, not the ID Token. MISE validates the Access Token sent in the Authorization header, and the claims from that token populate the `User` principal in your controllers.

## Token Claims Comparison

### With `access_as_user` (What We Get)
```json
{
  "aud": "1d922779-2742-4cf2-8c82-425cf2c60aa8",
  "iss": "https://login.microsoftonline.com/.../v2.0",
  "iat": 1702188123,
  "exp": 1702191723,
  "name": "Puneet Gupta",
  "preferred_username": "puneetg@microsoft.com",
  "oid": "...",
  "sub": "...",
  "idtyp": "user",
  "ver": "2.0",
  "scp": "access_as_user"
}
```

### With `.default` (App-Only Token)
```json
{
  "aud": "1d922779-2742-4cf2-8c82-425cf2c60aa8",
  "iss": "https://login.microsoftonline.com/.../v2.0",
  "iat": 1702188123,
  "exp": 1702191723,
  "idtyp": "app",
  "ver": "2.0",
  "roles": ["access_as_application"],
  "azp": "1d922779-2742-4cf2-8c82-425cf2c60aa8"
}
```

**Key Differences**:
- ❌ No `name`, `preferred_username`, `oid`, `sub` (no user info)
- ❌ `idtyp` is `app` instead of `user`
- ❌ Uses `roles` instead of `scp` (scopes)
- ❌ Application principal, not user principal

## MISE Compatibility

### MISE with User Tokens (Our Scenario)
```csharp
// MISE validates user tokens with idtyp: "user"
builder.Services.AddAuthentication(MiseAuthenticationDefaults.AuthenticationScheme)
    .AddMiseWithDefaultModules(builder.Configuration);

// Token must have:
// - idtyp: "user"
// - Delegated permissions (scp claim)
// - User identity claims
```

### MISE with App Tokens (Not Our Scenario)
```csharp
// Would need different MISE configuration
// Validates app tokens with idtyp: "app"
// Uses roles instead of scopes
// No user context available
```

## Common Mistakes

### ❌ Mistake 1: Using `.default` in SPA
```typescript
// WRONG - Don't do this in Angular SPA
scopes: ['api://1d922779-2742-4cf2-8c82-425cf2c60aa8/.default']
```
**Problem**: 
- Won't work with authorization code flow
- Requires client credentials (secrets)
- SPAs can't keep secrets secure
- No user context

### ❌ Mistake 2: Mixing Scopes Incorrectly
```typescript
// WRONG - Don't mix .default with delegated scopes
scopes: [
  'api://1d922779-2742-4cf2-8c82-425cf2c60aa8/access_as_user',
  'api://1d922779-2742-4cf2-8c82-425cf2c60aa8/.default'
]
```
**Problem**: `.default` will override all other scopes

### ❌ Mistake 3: Forgetting OpenID Scopes
```typescript
// WRONG - Missing OIDC scopes
scopes: ['api://1d922779-2742-4cf2-8c82-425cf2c60aa8/access_as_user']
```
**Problem**: Won't get id_token or user profile claims

### ✅ Correct Configuration (Our Setup)
```typescript
scopes: [
  'openid',
  'profile',
  'api://1d922779-2742-4cf2-8c82-425cf2c60aa8/access_as_user'
]
```

## Why Application ID URI Matters

### Our Configuration
```
Application ID URI: api://1d922779-2742-4cf2-8c82-425cf2c60aa8
Custom Scope: access_as_user
Full Scope: api://1d922779-2742-4cf2-8c82-425cf2c60aa8/access_as_user
```

**Benefits**:
1. **Clear Namespace**: Indicates this is an API resource
2. **Multi-Tenant Support**: Works across Microsoft tenants
3. **Best Practice**: Modern Entra ID recommendation
4. **Explicit Resource**: Clear which API the token is for

### Without `api://` Prefix
If we used just the ClientId, tokens would be less explicit about the resource.

## Real-World Scenarios

### Scenario 1: SPA + API (Our Project) ✅
- **Frontend**: Angular with MSAL.js
- **Backend**: ASP.NET Core with MISE
- **Auth Flow**: Authorization Code + PKCE
- **Scope**: `api://ClientId/access_as_user`
- **Token Type**: User token (`idtyp: user`)
- **Use Case**: User signs in, calls API as themselves

### Scenario 2: Daemon Service ❌ (Not Us)
- **Service**: Console app, Windows Service, Azure Function Timer
- **Backend**: ASP.NET Core API
- **Auth Flow**: Client Credentials
- **Scope**: `api://ClientId/.default` or `ClientId/.default`
- **Token Type**: App token (`idtyp: app`)
- **Use Case**: Automated background job, no user interaction

### Scenario 3: Web App Backend ✅ (Similar to Us)
- **Frontend**: ASP.NET MVC / Razor Pages
- **Backend**: ASP.NET Core API
- **Auth Flow**: Authorization Code
- **Scope**: `api://ClientId/access_as_user`
- **Token Type**: User token (`idtyp: user`)
- **Use Case**: Web app calling API on behalf of signed-in user

## Summary

| Question | Answer |
|----------|--------|
| **What scope do we use?** | `api://1d922779-2742-4cf2-8c82-425cf2c60aa8/access_as_user` |
| **Why this format?** | Custom delegated scope for user tokens |
| **Why not `.default`?** | That's for app-only tokens, we need user context |
| **Why `api://` prefix?** | Best practice, clear API namespace |
| **Can we use `.default` in SPA?** | No, it doesn't work with PKCE flow |
| **Do we need `openid` and `profile`?** | Yes, for OIDC authentication and user info |
| **Does MISE support this?** | Yes, with `idtyp: user` claim |
| **What if I want app-only access?** | Use `.default` but need different auth flow (client credentials) |

## Additional Resources

- [Microsoft Identity Platform Scopes](https://learn.microsoft.com/entra/identity-platform/scopes-oidc)
- [Delegated vs Application Permissions](https://learn.microsoft.com/entra/identity-platform/permissions-consent-overview)
- [.default Scope Behavior](https://learn.microsoft.com/entra/identity-platform/scopes-oidc#the-default-scope)
- [MSAL.js Scopes](https://github.com/AzureAD/microsoft-authentication-library-for-js/blob/dev/lib/msal-browser/docs/acquire-token.md)
