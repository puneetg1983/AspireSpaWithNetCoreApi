<div class="container">
  <header>
    <h1>{{ title }}</h1>
    <p class="subtitle">Single Entra ID App with PKCE Flow</p>
  </header>

  <!-- Authentication Status -->
  <div class="auth-section">
    <div *ngIf="!isAuthenticated" class="not-authenticated">
      <h2>üîí Not Authenticated</h2>
      <p>Please sign in to access the protected API</p>
      <button (click)="login()" class="btn btn-primary">Sign In with Microsoft</button>
    </div>

    <div *ngIf="isAuthenticated" class="authenticated">
      <h2>‚úÖ Authenticated</h2>
      <p><strong>User:</strong> {{ userName }}</p>
      
      <div class="button-group">
        <button (click)="callApi()" class="btn btn-success" [disabled]="loading">
          {{ loading ? 'Loading...' : 'Call ApiService' }}
        </button>
        <button (click)="callBackendService()" class="btn btn-primary" [disabled]="loadingBackend">
          {{ loadingBackend ? 'Loading...' : 'Call ApiService ‚Üí BackendProtectedService' }}
        </button>
        <button (click)="callOboService()" class="btn btn-warning" [disabled]="loadingObo">
          {{ loadingObo ? 'Loading...' : 'Call OBO Service' }}
        </button>
        <button (click)="getToken()" class="btn btn-info">View Token (Console)</button>
        <button (click)="logout()" class="btn btn-secondary">Sign Out</button>
      </div>
    </div>
  </div>

  <!-- API Response -->
  <div *ngIf="weatherData" class="api-response">
    <h3>üì° ApiService Response</h3>
    <p><strong>Service:</strong> {{ weatherData.service }}</p>
    <p><strong>Requested by:</strong> {{ weatherData.user }}</p>
    <p><strong>User ID:</strong> {{ weatherData.userId }}</p>
    
    <!-- Roles -->
    <div *ngIf="weatherData.roles && weatherData.roles.length > 0" class="roles-section">
      <h4>üé≠ User Roles</h4>
      <ul>
        <li *ngFor="let role of weatherData.roles">{{ role }}</li>
      </ul>
    </div>
    <p *ngIf="!weatherData.roles || weatherData.roles.length === 0"><em>No roles assigned</em></p>
    
    <!-- Claims (collapsible) -->
    <details class="claims-section">
      <summary><strong>üìã User Claims ({{ weatherData.claims?.length || 0 }})</strong></summary>
      <table class="claims-table">
        <thead>
          <tr>
            <th>Claim Type</th>
            <th>Value</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let claim of weatherData.claims">
            <td>{{ claim.type }}</td>
            <td>{{ claim.value }}</td>
          </tr>
        </tbody>
      </table>
    </details>
    
    <h4>Weather Forecast</h4>
    <table>
      <thead>
        <tr>
          <th>Date</th>
          <th>Temp (C)</th>
          <th>Temp (F)</th>
          <th>Summary</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let item of weatherData.forecast">
          <td>{{ item.date }}</td>
          <td>{{ item.temperatureC }}</td>
          <td>{{ item.temperatureF }}</td>
          <td>{{ item.summary }}</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Error Display -->
  <div *ngIf="error" class="error">
    <h3>‚ùå Error</h3>
    <p>{{ error }}</p>
  </div>

  <!-- Backend Service Response -->
  <div *ngIf="backendData" class="api-response">
    <h3>üîó ApiService ‚Üí BackendProtectedService Response</h3>
    <p><strong>Message:</strong> {{ backendData.message }}</p>
    <p><strong>Called by:</strong> {{ backendData.calledBy }}</p>
    
    <div *ngIf="backendData.backendResponse">
      <h4>BackendProtectedService Data:</h4>
      <p><strong>Service:</strong> {{ backendData.backendResponse.service }}</p>
      <p><strong>Requested by:</strong> {{ backendData.backendResponse.requestedBy }}</p>
      <p><strong>User ID:</strong> {{ backendData.backendResponse.userId }}</p>
      <p><strong>Timestamp:</strong> {{ backendData.backendResponse.timestamp }}</p>
      
      <!-- Roles -->
      <div *ngIf="backendData.backendResponse.roles && backendData.backendResponse.roles.length > 0" class="roles-section">
        <h4>üé≠ User Roles</h4>
        <ul>
          <li *ngFor="let role of backendData.backendResponse.roles">{{ role }}</li>
        </ul>
      </div>
      <p *ngIf="!backendData.backendResponse.roles || backendData.backendResponse.roles.length === 0"><em>No roles assigned</em></p>
      
      <!-- Claims (collapsible) -->
      <details class="claims-section">
        <summary><strong>üìã User Claims ({{ backendData.backendResponse.claims?.length || 0 }})</strong></summary>
        <table class="claims-table">
          <thead>
            <tr>
              <th>Claim Type</th>
              <th>Value</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let claim of backendData.backendResponse.claims">
              <td>{{ claim.type }}</td>
              <td>{{ claim.value }}</td>
            </tr>
          </tbody>
        </table>
      </details>
      
      <h4>Data Items</h4>
      <table *ngIf="backendData.backendResponse.data">
        <thead>
          <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Value</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let item of backendData.backendResponse.data">
            <td>{{ item.id }}</td>
            <td>{{ item.name }}</td>
            <td>{{ item.value }}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Backend Error Display -->
  <div *ngIf="backendError" class="error">
    <h3>‚ùå Backend Service Error</h3>
    <p>{{ backendError }}</p>
  </div>

  <!-- OBO Service Response -->
  <div *ngIf="oboData" class="api-response obo-response">
    <h3>üîÑ OBO (On-Behalf-Of) Service Response</h3>
    <p><strong>Message:</strong> {{ oboData.message }}</p>
    <p><strong>Called by:</strong> {{ oboData.calledBy }}</p>
    <p><strong>OBO Flow Info:</strong> {{ oboData.oboFlowInfo }}</p>
    
    <div *ngIf="oboData.backendResponse">
      <h4>BackendServiceAcceptingToken Data:</h4>
      <p><strong>Message:</strong> {{ oboData.backendResponse.message }}</p>
      <p><strong>Service:</strong> {{ oboData.backendResponse.service }}</p>
      <p><strong>Entra App ID:</strong> {{ oboData.backendResponse.entraAppId }}</p>
      <p><strong>Token Type:</strong> {{ oboData.backendResponse.tokenType }}</p>
      <p><strong>Requested by:</strong> {{ oboData.backendResponse.requestedBy }}</p>
      <p><strong>User ID:</strong> {{ oboData.backendResponse.userId }}</p>
      <p><strong>Timestamp:</strong> {{ oboData.backendResponse.timestamp }}</p>
      
      <!-- Roles -->
      <div *ngIf="oboData.backendResponse.roles && oboData.backendResponse.roles.length > 0" class="roles-section">
        <h4>üé≠ User Roles (from OBO token)</h4>
        <ul>
          <li *ngFor="let role of oboData.backendResponse.roles">{{ role }}</li>
        </ul>
      </div>
      <p *ngIf="!oboData.backendResponse.roles || oboData.backendResponse.roles.length === 0"><em>No roles assigned in OBO token</em></p>
      
      <!-- Claims (collapsible) -->
      <details class="claims-section">
        <summary><strong>üìã User Claims from OBO Token ({{ oboData.backendResponse.claims?.length || 0 }})</strong></summary>
        <table class="claims-table">
          <thead>
            <tr>
              <th>Claim Type</th>
              <th>Value</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let claim of oboData.backendResponse.claims">
              <td>{{ claim.type }}</td>
              <td>{{ claim.value }}</td>
            </tr>
          </tbody>
        </table>
      </details>
      
      <h4>Data Items</h4>
      <table *ngIf="oboData.backendResponse.data">
        <thead>
          <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Description</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let item of oboData.backendResponse.data">
            <td>{{ item.id }}</td>
            <td>{{ item.name }}</td>
            <td>{{ item.description }}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- OBO Error Display -->
  <div *ngIf="oboError" class="error">
    <h3>‚ùå OBO Service Error</h3>
    <p>{{ oboError }}</p>
  </div>

  <!-- Configuration Info -->
  <div class="config-info">
    <h3>Configuration Details</h3>
    <ul>
      <li><strong>Client ID:</strong> 1d922779-2742-4cf2-8c82-425cf2c60aa8</li>
      <li><strong>Authority:</strong> https://login.microsoftonline.com/common</li>
      <li><strong>Scopes:</strong> openid, profile, api://1d922779-2742-4cf2-8c82-425cf2c60aa8/access_as_user</li>
      <li><strong>Flow:</strong> Authorization Code with PKCE (no client secret)</li>
    </ul>
  </div>
</div>
